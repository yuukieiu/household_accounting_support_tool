<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">
  <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
  <style>
    .error { border: 2px solid red !important; }
    @keyframes fadeinout {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(20px); }
    }
    .animate-fadeinout { animation: fadeinout 3s forwards; }
    .tooltip-icon {
      display: inline-block;
      margin-left: 4px;
      color: #3b82f6;
      font-weight: bold;
      border-radius: 50%;
      width: 18px; height: 18px;
      text-align: center;
      line-height: 18px;
      cursor: help;
      background-color: #e0f2fe;
    }
    .tooltip-icon:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .tooltiptext {
      visibility: hidden;
      width: 220px;
      background-color: #333;
      color: #fff;
      text-align: left;
      padding: 5px;
      border-radius: 5px;
      position: absolute;
      z-index: 10;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-overlay.active {
      display: flex;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="p-4 bg-gray-50 font-sans">
  <div class="mb-3">
    <span class="text-red-500 font-bold">*</span> 取引タイプ<br>
    <input type="radio" name="type" value="収入" id="typeIncome" checked>
    <label for="typeIncome">収入</label>
    <input type="radio" name="type" value="支出" id="typeExpense">
    <label for="typeExpense">支出</label>
  </div>

  <div class="mb-3">
    <span class="text-red-500 font-bold">*</span> 取引日<br>
    <input type="text" id="date" class="mt-1 w-full border rounded p-1">
  </div>

  <div class="mb-3 relative">
    <span class="text-red-500 font-bold">*</span> 取引手段
    <span class="tooltip-icon">?
      <span class="tooltiptext">例: カード引き落としなら「普通預金」、給与受取なら「普通預金」など、取引で変動した資産を選択</span>
    </span><br>
    <select id="payment" class="mt-1 w-full border rounded p-1"></select>
  </div>

  <div class="mb-3 relative">
    <span class="text-red-500 font-bold">*</span> 相手科目
    <span class="tooltip-icon">?
      <span class="tooltiptext">例: 支出なら「未払金」、収入なら「給与」など、相手側の勘定科目を選択</span>
    </span><br>
    <select id="purpose" class="mt-1 w-full border rounded p-1"></select>
  </div>

  <div class="mb-3">
    <span class="text-red-500 font-bold">*</span> 金額<br>
    <input type="number" id="amount" class="mt-1 w-full border rounded p-1">
  </div>

  <div class="mb-3">
    <span class="text-red-500 font-bold">*</span> 摘要<br>
    <input type="text" id="description" class="mt-1 w-full border rounded p-1">
  </div>

  <button id="submitBtn" onclick="submitData()" class="mt-3 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded disabled:bg-gray-400 disabled:cursor-not-allowed">
    登録
  </button>

  <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <script>
    let paymentChoice, purposeChoice;
    let paymentValues = [], purposeValues = [];

    const picker = new Pikaday({
      field: document.getElementById('date'),
      format: 'YYYY-MM-DD',
      defaultDate: new Date(),
      setDefaultDate: true,
      toString(date) {
        const y = date.getFullYear();
        const m = ('0' + (date.getMonth() + 1)).slice(-2);
        const d = ('0' + date.getDate()).slice(-2);
        return `${y}-${m}-${d}`;
      }
    });

    google.script.run.withSuccessHandler(function(accounts){
      const paymentList = accounts.filter(acc => ["資産","負債","純資産"].includes(acc.category));
      const purposeList = accounts.filter(acc => ["費用","収益","純資産","負債"].includes(acc.category));

      const paymentSelect = document.getElementById("payment");
      const purposeSelect = document.getElementById("purpose");

      paymentValues = paymentList.map(acc => acc.name);
      purposeValues = purposeList.map(acc => acc.name);

      paymentList.forEach(acc => {
        const o = document.createElement("option");
        o.value = acc.name;
        o.text = acc.display;
        paymentSelect.appendChild(o);
      });

      purposeList.forEach(acc => {
        const o = document.createElement("option");
        o.value = acc.name;
        o.text = acc.display;
        purposeSelect.appendChild(o);
      });

      paymentChoice = new Choices(paymentSelect, { searchEnabled: true, removeItemButton: false });
      purposeChoice = new Choices(purposeSelect, { searchEnabled: true, removeItemButton: false });
    }).getAccounts();

    function showToast(msg) {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "bg-green-500 text-white px-4 py-2 rounded shadow mb-2 animate-fadeinout";
      toast.textContent = msg;
      container.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 3000);
    }

    function submitData() {
      let valid = true;
      const type = document.querySelector('input[name="type"]:checked').value;
      const dateEl = document.getElementById("date");
      const paymentEl = document.getElementById("payment");
      const purposeEl = document.getElementById("purpose");
      const amountEl = document.getElementById("amount");
      const descriptionEl = document.getElementById("description");
      const submitBtn = document.getElementById("submitBtn");
      const loadingOverlay = document.getElementById("loadingOverlay");

      [dateEl,paymentEl,purposeEl,amountEl,descriptionEl].forEach(el => el.classList.remove("error"));

      if(!dateEl.value) { dateEl.classList.add("error"); valid = false; }
      if(!paymentValues.includes(paymentEl.value)) { paymentEl.classList.add("error"); valid = false; }
      if(!purposeValues.includes(purposeEl.value)) { purposeEl.classList.add("error"); valid = false; }
      const amount = Number(amountEl.value);
      if(!(amount>=0)) { amountEl.classList.add("error"); valid = false; }
      const description = descriptionEl.value.trim();
      if(description.length ===0) { descriptionEl.classList.add("error"); valid = false; }

      if(!valid) return;

      // 登録ボタンを非活性化し、ローディングオーバーレイを表示
      submitBtn.disabled = true;
      loadingOverlay.classList.add("active");

      let debitName, creditName;
      if(type==="収入") { debitName = paymentEl.value; creditName = purposeEl.value; }
      else { debitName = purposeEl.value; creditName = paymentEl.value; }

      // 処理完了時のコールバック（成功時）
      const onSuccess = () => {
        try {
          dateEl.value = picker.toString(new Date());
          amountEl.value = "";
          descriptionEl.value = "";
          showToast("入力完了");
        } catch(e) { console.error(e); }
        // 登録ボタンを再有効化し、ローディングオーバーレイを非表示
        submitBtn.disabled = false;
        loadingOverlay.classList.remove("active");
      };

      // エラー時のコールバック
      const onFailure = (error) => {
        console.error("登録エラー:", error);
        showToast("登録に失敗しました");
        // 登録ボタンを再有効化し、ローディングオーバーレイを非表示
        submitBtn.disabled = false;
        loadingOverlay.classList.remove("active");
      };

      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .addJournalEntry({
          type, payment: paymentEl.value, purpose: purposeEl.value,
          date: dateEl.value, debitName, creditName,
          debitAmount: amount, description
        });
    }
  </script>
</body>
</html>
